<div class="min-h-screen bg-white">
  <!-- Toast -->
  <p-toast></p-toast>

  <!-- Header -->
  <div class="bg-white border-b border-gray-200 sticky top-0 z-10">
    <div class="max-w-7xl mx-auto px-4 py-4">
      <div class="flex items-center justify-between gap-3">
        <div class="flex items-center gap-3">
          <button class="p-2 hover:bg-gray-100 rounded-lg transition-colors" (click)="goBack()">
            <i class="pi pi-arrow-left text-blue-600"></i>
          </button>
          <h1 class="text-xl font-bold text-gray-900">
            {{tareasService.apartadoadmin ? 'Tarea' : 'Tarea N° ' + (tarea?.id || '0')}}
          </h1>
        </div>
        <!-- Navegación rápida -->
        <div class="flex items-center gap-2">
          <a routerLink="/tareas" class="px-3 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100 rounded-lg transition-colors flex items-center gap-2">
            <i class="pi pi-list text-blue-600"></i>
            <span class="hidden sm:inline">Mis Tareas</span>
          </a>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="isLoading" class="flex justify-center items-center py-20">
    <i class="pi pi-spin pi-spinner text-4xl text-blue-600"></i>
  </div>

  <div *ngIf="!isLoading" class="max-w-7xl mx-auto px-4 py-6">
    <!-- Tarjeta de tarea -->
    <div class="bg-blue-50 border-l-4 border-blue-500 rounded-lg p-4 mb-6">
      <div class="flex justify-between items-start gap-3">
        <h2 class="text-base font-semibold text-gray-900 flex-1">
          {{tarea?.titulo}}
        </h2>
        <span class="px-3 py-1 rounded-full text-sm font-medium whitespace-nowrap"
              [ngClass]="{
                'bg-yellow-500 text-white': tarea?.estado === 'Pendiente',
                'bg-blue-500 text-white': tarea?.estado === 'En progreso',
                'bg-orange-500 text-white': tarea?.estado === 'Pausada',
                'bg-green-500 text-white': tarea?.estado === 'Completada',
                'bg-gray-400 text-white': tarea?.estado === 'Cerrada'
              }">
          {{tarea?.estado || 'Pendiente'}}
        </span>
      </div>
    </div>

    <!-- Descripción -->
    <div class="mb-6">
      <h3 class="text-sm font-bold text-gray-700 mb-2">Descripción</h3>
      <p class="text-sm text-gray-600 leading-relaxed">
        {{tarea?.descripcion}}
      </p>
    </div>

    <!-- Información de la tarea -->
    <div class="mb-6">
      <div class="grid grid-cols-2 gap-4 mb-3" *ngIf="!tareasService.apartadoadmin">
        <div class="flex items-center gap-2 text-sm">
          <i class="pi pi-tag text-gray-500"></i>
          <span class="text-gray-600">Categoría:</span>
          <span class="font-medium text-gray-900">{{tarea?.Categoria || 'Sin categoría'}}</span>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <i class="pi pi-tag text-gray-500"></i>
          <span class="text-gray-600">SubCategoría:</span>
          <span class="font-medium text-gray-900">{{tarea?.Categoria || 'Sin categoría'}}</span>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-4" *ngIf="tareasService.apartadoadmin">
        <div class="flex items-center gap-2 text-sm">
          <i class="pi pi-tag text-gray-500"></i>
          <span class="text-gray-600">Subcategoría:</span>
          <span class="font-medium text-gray-900">{{tarea?.Categoria}}</span>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <i class="pi pi-folder text-gray-500"></i>
          <span class="text-gray-600">Estado:</span>
          <span class="font-medium text-gray-900">{{tarea?.estado}}</span>
        </div>
      </div>

      <div class="grid grid-cols-3 gap-4 mt-3">
        <div class="flex items-center gap-2 text-sm">
          <i class="pi pi-clock text-gray-500"></i>
          <span class="text-gray-600">Programada:</span>
          <span class="font-medium text-gray-900">{{tarea?.horainicio}}</span>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <i class="pi pi-clock text-gray-500"></i>
          <span class="text-gray-600">Inicio:</span>
          <span class="font-medium text-gray-900">{{tarea?.horainicio || 'Sin hora inicio'}}</span>
        </div>
        <div class="flex items-center gap-2 text-sm">
          <i class="pi pi-clock text-gray-500"></i>
          <span class="text-gray-600">Fin:</span>
          <span class="font-medium text-gray-900">{{tarea?.horafin || 'Sin hora fin'}}</span>
        </div>
      </div>

      <!-- Prioridad -->
      <div *ngIf="!tareasService.apartadoadmin && tarea?.Prioridad" class="mt-4">
        <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full text-sm" [ngClass]="getPrioridadColor()">
          <i class="pi pi-flag-fill"></i>
          {{tarea?.Prioridad}}
        </span>
      </div>
    </div>

    <!-- Sección de Historial de la Tarea -->
    <div *ngIf="historial.length > 0" class="mb-6">
      <!-- Header -->
      <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-t-xl border border-gray-200 px-4 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center">
              <i class="pi pi-history text-white text-sm"></i>
            </div>
            <div>
              <h3 class="text-sm font-bold text-gray-900">Historial de la Tarea</h3>
              <p class="text-xs text-gray-600">{{historial.length}} registro(s)</p>
            </div>
          </div>
          <button 
            type="button"
            class="px-3 py-1.5 text-xs font-medium text-blue-700 bg-white border border-blue-200 rounded-lg hover:bg-blue-50 transition-colors flex items-center gap-1.5"
            (click)="toggleHistorial()">
            <span>{{mostrarHistorial ? 'Ocultar' : 'Ver historial'}}</span>
            <i class="pi text-xs" [ngClass]="mostrarHistorial ? 'pi-chevron-up' : 'pi-chevron-down'"></i>
          </button>
        </div>
      </div>

      <!-- Timeline de eventos -->
      <div *ngIf="mostrarHistorial" class="bg-white border-x border-b border-gray-200 rounded-b-xl p-4">
        <div class="relative">
          <!-- Línea vertical del timeline -->
          <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>
          
          <!-- Lista de eventos -->
          <div class="space-y-4">
            <div *ngFor="let item of historial; let isLast = last" class="relative pl-10">
              <!-- Punto del timeline -->
              <div class="absolute left-2 top-1 w-4 h-4 rounded-full flex items-center justify-center shadow-md"
                   [ngClass]="getTipoComentarioBadgeColor(item.accion)">
                <i class="pi text-white text-xs" [ngClass]="getTipoComentarioIcon(item.accion)"></i>
              </div>
              
              <!-- Contenido del evento -->
              <div class="bg-gray-50 rounded-lg p-4 hover:shadow-md transition-shadow border border-gray-100">
                <!-- Header del evento -->
                <div class="flex items-start justify-between gap-3 mb-3">
                  <div class="flex-1">
                    <h4 class="text-sm font-semibold text-gray-900 mb-1">
                      {{getTipoComentarioLabel(item.accion)}}
                    </h4>
                    <div class="flex items-center gap-2 text-xs text-gray-600">
                      <div class="flex items-center gap-1">
                        <i class="pi pi-user"></i>
                        <span class="font-medium">{{item.usuario_nombre || 'Sistema'}}</span>
                      </div>
                      <span class="text-gray-400">•</span>
                      <div class="flex items-center gap-1">
                        <i class="pi pi-clock"></i>
                        <span>{{formatearFechaCompleta(item.fecha_accion)}}</span>
                      </div>
                    </div>
                  </div>
                </div>
                
                <!-- Comentario (si existe) -->
                <div *ngIf="tieneComentario(item)" class="mt-3 pt-3 border-t border-gray-200">
                  <div class="flex items-start gap-2">
                    <i class="pi pi-comment text-gray-400 text-sm mt-0.5"></i>
                    <div class="flex-1">
                      <p class="text-xs text-gray-500 font-medium mb-1">Comentario:</p>
                      <p class="text-sm text-gray-700 leading-relaxed whitespace-pre-line">{{item.comentario}}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Mensaje si no hay historial -->
        <div *ngIf="historial.length === 0" class="text-center py-12">
          <div class="w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mx-auto mb-3">
            <i class="pi pi-history text-gray-400 text-2xl"></i>
          </div>
          <p class="text-sm text-gray-500 font-medium">No hay registros en el historial</p>
          <p class="text-xs text-gray-400 mt-1">Los eventos de la tarea aparecerán aquí</p>
        </div>
      </div>
    </div>

    <!-- Alerta para tareas pendientes -->
    <div *ngIf="tarea?.estado === 'Pendiente'" class="bg-orange-50 border border-orange-200 rounded-lg p-3 mb-6 flex items-center gap-3">
      <i class="pi pi-info-circle text-orange-500"></i>
      <p class="text-sm text-orange-700">Para agregar un comentario o imagen, inicia la tarea.</p>
    </div>

    <!-- Comentarios -->
    <div *ngIf="tarea?.estado !== 'Cerrada' && tarea?.estado !== 'Completada'" class="mb-6">
      <h3 class="text-sm font-bold text-gray-700 mb-2">
        Agrega un comentario <span class="text-xs text-gray-500">(Opcional)</span>
      </h3>
      <textarea 
        rows="4"
        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
        placeholder="Escribe aquí"
        [(ngModel)]="comentario"
        [disabled]="tarea?.estado === 'Pendiente'"></textarea>
    </div>

    <!-- Comentario para tareas cerradas -->
    <div *ngIf="tarea?.estado === 'Cerrada' || tarea?.id === '1'" class="mb-6">
      <h3 class="text-sm font-bold text-gray-700 mb-2">
        Comentario <span class="text-xs text-gray-500">(Opcional)</span>
      </h3>
      <div class="bg-gray-50 rounded-lg p-3">
        <p class="text-sm text-gray-500 italic">No hay comentario.</p>
      </div>
    </div>

    <!-- Comentario para tareas completadas -->
    <!-- <div *ngIf="tarea?.estado === 'Completada' && tarea?.id !== '1'" class="mb-6">
      <h3 class="text-sm font-bold text-gray-700 mb-2">
        Comentario <span class="text-xs text-gray-500">(Opcional)</span>
      </h3>
      <div class="bg-gray-50 rounded-lg p-3">
        <p class="text-sm text-gray-700">{{comentario}}</p>
      </div>
    </div> -->

    <!-- Botones de acción -->
    <div class="flex gap-3 mt-6">
      <button *ngIf="tarea?.estado === 'Pendiente' || tarea?.estado === 'Pausada'"
              class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors font-medium"
              (click)="iniciarTarea()">
        <i class="pi pi-play mr-2"></i>
        {{tarea?.estado === 'Pausada' ? 'Reanudar Tarea' : 'Iniciar Tarea'}}
      </button>

      <button *ngIf="tarea?.estado === 'En progreso'"
              class="flex-1 px-4 py-3 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 transition-colors font-medium"
              (click)="pausarTarea()">
        <i class="pi pi-pause mr-2"></i>
        Pausar Tarea
      </button>

      <button *ngIf="tarea?.estado === 'En progreso'"
              class="flex-1 px-4 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors font-medium"
              (click)="completarTarea()">
        <i class="pi pi-check mr-2"></i>
        Completar Tarea
      </button>

      <button *ngIf="tarea?.estado === 'En progreso'"
              class="px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors"
              (click)="adjuntarImagen()">
        <i class="pi pi-paperclip"></i>
      </button>
    </div>

    <!-- Botón de reapertura para tareas completadas -->
    <div class="flex gap-3 mt-4" *ngIf="tarea?.estado === 'Completada'">
      <a 
        class="w-full px-4 py-3 bg-orange-600 text-white rounded-lg hover:bg-orange-700 transition-colors font-medium flex items-center justify-center gap-2 cursor-pointer no-underline"
        [routerLink]="['/tareas/tarea-reapertura', tarea?.id]">
        <i class="pi pi-replay"></i>
        <span>Reabrir Tarea</span>
      </a>
    </div>
  </div> <!-- Cierre del div *ngIf="!isLoading" -->
</div> <!-- Cierre del div min-h-screen -->
